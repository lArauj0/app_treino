<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <link rel="manifest" href="manifest.json">
    <title>Treino Tracker Pro</title>
    <style>
        /* --- ESTILOS GERAIS (DARK MODE) --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 15px; user-select: none; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        
        /* Dashboard */
        .dashboard {
            display: flex; justify-content: space-between; gap: 8px; max-width: 400px; margin: 0 auto 20px auto;
            background: #1e1e1e; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .stat-box { flex: 1; text-align: center; }
        .stat-number { font-size: 1.4rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.6rem; text-transform: uppercase; color: #888; letter-spacing: 1px; margin-top: 5px;}
        .color-green { color: #03dac6; }
        .color-red { color: #cf6679; }
        .color-purple { color: #bb86fc; }

        /* Navega√ß√£o M√™s */
        .month-nav { display: flex; justify-content: space-between; align-items: center; max-width: 400px; margin: 0 auto 15px auto; }
        .nav-btn { background: #2c2c2c; border: none; color: #fff; font-size: 1.2rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-btn:active { background-color: #444; }
        h3 { margin: 0; color: #bb86fc; font-weight: normal; font-size: 1.2rem; }

        /* Calend√°rio */
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 400px; margin: 0 auto 5px auto; font-size: 0.8rem; color: #666; text-align: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 400px; margin: 0 auto; }
        
        .day {
            aspect-ratio: 1; background-color: #2c2c2c; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 5px;
            font-size: 0.9rem; cursor: pointer; position: relative; transition: 0.1s; overflow: hidden;
        }
        .day:active { transform: scale(0.95); }
        .day.is-today { border: 2px solid #fff; box-sizing: border-box; }
        
        /* Estilo do texto do treino DENTRO do dia */
        .day-workout-name {
            font-size: 0.6rem;
            line-height: 1.1;
            margin-top: 2px;
            text-align: center;
            width: 95%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: normal;
        }

        .treinou { background-color: #03dac6; color: #000; font-weight: bold; box-shadow: 0 0 5px rgba(3, 218, 198, 0.3); }
        .nao-treinou { background-color: #cf6679; color: #000; opacity: 0.9; }

        /* Lista de Hist√≥rico (Abaixo do Calend√°rio) */
        .history-list-container { max-width: 400px; margin: 25px auto 0 auto; }
        .history-item { 
            background: #1e1e1e; padding: 12px; margin-bottom: 8px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #333;
        }
        .h-date { color: #888; font-size: 0.8rem; margin-right: 10px; min-width: 40px;}
        .h-info { text-align: left; flex: 1; }
        .h-name { display: block; font-weight: bold; color: white; font-size: 0.95rem; }
        .h-obs { display: block; font-size: 0.75rem; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        .border-green { border-left-color: #03dac6; }
        .border-red { border-left-color: #cf6679; }

        /* Modais e Forms */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e1e1e; width: 85%; max-width: 350px; padding: 25px; border-radius: 15px; border: 1px solid #333; text-align: center; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        button.btn-action { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; margin-bottom: 5px; }
        .btn-primary { background: #bb86fc; color: #000; }
        .btn-confirm { background: #03dac6; color: #000; }
        .btn-danger { background: #cf6679; color: #000; }
        .btn-outline { background: transparent; border: 1px solid #666; color: #888; margin-top: 5px;}
        .btn-warning { background: #ffb74d; color: #000; }

        /* Lista Templates */
        .hidden { display: none; }
        .template-item { background: #2c2c2c; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .template-actions { display: flex; gap: 5px; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Menu Inferior */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #1e1e1e; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 50; }
        .nav-item { font-size: 0.75rem; color: #666; text-align: center; cursor: pointer; }
        .nav-item.active { color: #bb86fc; font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="view-calendar">
        <div class="dashboard">
            <div class="stat-box">
                <span class="stat-number color-green" id="totalDone">0</span>
                <span class="stat-label">Treinos</span>
            </div>
            <div class="stat-box">
                <span class="stat-number color-red" id="totalRest">0</span>
                <span class="stat-label">Descanso</span>
            </div>
            <div class="stat-box">
                <span class="stat-number color-purple" id="successRate">0%</span>
                <span class="stat-label">Foco</span>
            </div>
        </div>

        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">&#10094;</button>
            <h3 id="monthYear"></h3>
            <button class="nav-btn" onclick="changeMonth(1)">&#10095;</button>
        </div>

        <div class="weekdays">
            <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
        </div>
        <div class="calendar-grid" id="calendar"></div>
        
        <div class="history-list-container">
            <h4 style="color: #666; font-weight: normal; font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                Hist√≥rico deste m√™s
            </h4>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="view-templates" class="hidden" style="max-width: 400px; margin: 0 auto;">
        <h2 style="color: #bb86fc; text-align: center; margin-bottom: 20px;">Gerenciar Treinos</h2>
        
        <div style="background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #333;">
            <label style="color: #888; font-size: 0.8rem; margin-bottom: 5px; display: block;">Nome do Treino</label>
            <input type="text" id="tpl-nome" placeholder="Ex: Peito A">
            <label style="color: #888; font-size: 0.8rem; margin-bottom: 5px; display: block;">Detalhes / Obs</label>
            <textarea id="tpl-obs" placeholder="Ex: Supino 4x10..."></textarea>
            
            <button id="btn-save-tpl" class="btn-action btn-primary" onclick="salvarOuAtualizarTemplate()">+ Salvar Treino</button>
            <button id="btn-cancel-edit" class="btn-action btn-outline hidden" onclick="cancelarEdicao()">Cancelar</button>
        </div>

        <h4 style="color: #888; text-transform: uppercase; font-size: 0.8rem;">Seus Modelos:</h4>
        <div id="lista-templates"></div>
        <div style="height: 50px;"></div>
    </div>

    <div id="modal-treino" class="modal" onclick="fecharModal(event)">
        <div class="modal-content">
            <h3 id="modal-date-title" style="margin-top:0; color:#bb86fc;">Data</h3>
            <hr style="border: 1px solid #333; margin-bottom: 15px;">
            
            <label style="display:block; text-align:left; color:#ccc; margin-bottom:8px; font-size:0.9rem;">Treino realizado:</label>
            <select id="modal-select">
                <option value="">Selecione...</option>
                </select>

            <button class="btn-action btn-confirm" onclick="salvarTreinoDoDia('done')">‚úÖ Confirmar</button>
            <button class="btn-action btn-danger" onclick="salvarTreinoDoDia('rest')">üí§ Descanso</button>
            <button class="btn-action btn-outline" onclick="salvarTreinoDoDia('clear')">üóëÔ∏è Limpar</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navegar('calendar')">
            <span class="nav-icon">üìÖ</span> Calend√°rio
        </div>
        <div class="nav-item" onclick="navegar('templates')">
            <span class="nav-icon">‚öôÔ∏è</span> Treinos
        </div>
    </nav>

    <script>
        // --- DADOS ---
        let viewDate = new Date();
        const todayDate = new Date();
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        let history = JSON.parse(localStorage.getItem('gym_history_v2')) || {};
        let templates = JSON.parse(localStorage.getItem('gym_templates_v2')) || [];
        
        let editingId = null;
        let selectedDayKey = null;

        // --- INICIALIZA√á√ÉO ---
        renderCalendar();
        renderTemplates();
        updateStats();

        // --- NAVEGA√á√ÉO ---
        function navegar(page) {
            document.getElementById('view-calendar').classList.add('hidden');
            document.getElementById('view-templates').classList.add('hidden');
            
            if (page === 'calendar') document.getElementById('view-calendar').classList.remove('hidden');
            if (page === 'templates') document.getElementById('view-templates').classList.remove('hidden');

            const items = document.querySelectorAll('.nav-item');
            items[0].classList.toggle('active', page === 'calendar');
            items[1].classList.toggle('active', page === 'templates');
        }

        // --- CRUD TEMPLATES ---
        function salvarOuAtualizarTemplate() {
            const nome = document.getElementById('tpl-nome').value;
            const obs = document.getElementById('tpl-obs').value;

            if(!nome) return alert("Digite o nome do treino!");

            if (editingId) {
                const index = templates.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    templates[index].nome = nome;
                    templates[index].obs = obs;
                    alert("Atualizado!");
                }
            } else {
                templates.push({ id: Date.now(), nome: nome, obs: obs });
                alert("Criado!");
            }

            localStorage.setItem('gym_templates_v2', JSON.stringify(templates));
            cancelarEdicao();
            renderTemplates();
        }

        function prepararEdicao(id) {
            const treino = templates.find(t => t.id === id);
            if (!treino) return;
            document.getElementById('tpl-nome').value = treino.nome;
            document.getElementById('tpl-obs').value = treino.obs || '';
            editingId = id;
            document.getElementById('btn-save-tpl').innerText = "Atualizar";
            document.getElementById('btn-save-tpl').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelarEdicao() {
            editingId = null;
            document.getElementById('tpl-nome').value = '';
            document.getElementById('tpl-obs').value = '';
            document.getElementById('btn-save-tpl').innerText = "+ Salvar Treino";
            document.getElementById('btn-save-tpl').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function deletarTemplate(id) {
            if(confirm("Apagar?")) {
                templates = templates.filter(t => t.id !== id);
                localStorage.setItem('gym_templates_v2', JSON.stringify(templates));
                renderTemplates();
                if (editingId === id) cancelarEdicao();
            }
        }

        function renderTemplates() {
            const div = document.getElementById('lista-templates');
            div.innerHTML = '';
            if (templates.length === 0) {
                div.innerHTML = '<p style="text-align:center; color:#555;">Sem treinos cadastrados.</p>';
                return;
            }
            templates.forEach(t => {
                div.innerHTML += `
                    <div class="template-item">
                        <div style="flex:1">
                            <strong style="color:white;">${t.nome}</strong>
                            <div style="font-size:0.8rem; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">${t.obs || ''}</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-mini btn-warning" onclick="prepararEdicao(${t.id})">‚úé</button>
                            <button class="btn-mini btn-danger" onclick="deletarTemplate(${t.id})">X</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- CALEND√ÅRIO ---
        function changeMonth(step) {
            viewDate.setMonth(viewDate.getMonth() + step);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar');
            const title = document.getElementById('monthYear');
            grid.innerHTML = '';

            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            title.innerText = `${monthNames[month]} ${year}`;

            const firstDayIndex = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // C√©lulas vazias
            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement('div'));

            // Dias
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('day');
                
                const dayKey = `${year}-${month}-${i}`;
                let innerHTML = `<span style="font-weight:bold">${i}</span>`;

                if (i === todayDate.getDate() && month === todayDate.getMonth() && year === todayDate.getFullYear()) {
                    dayDiv.classList.add('is-today');
                }

                if (history[dayKey]) {
                    if (history[dayKey] === 'REST') {
                        dayDiv.classList.add('nao-treinou');
                        innerHTML += `<span class="day-workout-name">OFF</span>`;
                    } else {
                        dayDiv.classList.add('treinou');
                        // Aqui est√° o truque: mostra o nome do treino dentro do quadrado
                        innerHTML += `<span class="day-workout-name">${history[dayKey]}</span>`;
                    }
                }

                dayDiv.innerHTML = innerHTML;
                dayDiv.onclick = () => abrirModal(dayKey, i);
                grid.appendChild(dayDiv);
            }
            
            // Renderiza tamb√©m a lista abaixo do calend√°rio
            renderHistoryList(year, month);
        }

        function renderHistoryList(year, month) {
            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = '';

            // Filtra logs do m√™s atual
            const entries = Object.entries(history).filter(([key, value]) => {
                const parts = key.split('-');
                return parseInt(parts[0]) === year && parseInt(parts[1]) === month;
            });

            // Ordena do mais recente para o antigo
            entries.sort((a, b) => {
                const dayA = parseInt(a[0].split('-')[2]);
                const dayB = parseInt(b[0].split('-')[2]);
                return dayB - dayA;
            });

            if (entries.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; color:#444; font-size:0.8rem;">Nenhum registro este m√™s.</p>';
                return;
            }

            entries.forEach(([key, value]) => {
                const day = key.split('-')[2];
                const isRest = value === 'REST';
                
                // Tenta achar detalhes do treino para mostrar obs na lista (se houver)
                const tpl = templates.find(t => t.nome === value);
                const obs = tpl ? tpl.obs : '';

                listDiv.innerHTML += `
                    <div class="history-item ${isRest ? 'border-red' : 'border-green'}">
                        <div class="h-date">${day}/${month+1}</div>
                        <div class="h-info">
                            <span class="h-name" style="${isRest ? 'color:#cf6679' : 'color:#03dac6'}">${isRest ? 'Descanso / Off' : value}</span>
                            ${!isRest && obs ? `<span class="h-obs">${obs}</span>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- STATS ---
        function updateStats() {
            let done = 0;
            let rest = 0;
            Object.values(history).forEach(val => {
                if (val === 'REST') rest++;
                else done++;
            });

            document.getElementById('totalDone').innerText = done;
            document.getElementById('totalRest').innerText = rest;
            const total = done + rest;
            const rate = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('successRate').innerText = rate + "%";
        }

        // --- MODAL ---
        function abrirModal(key, day) {
            selectedDayKey = key;
            const modal = document.getElementById('modal-treino');
            const select = document.getElementById('modal-select');
            
            select.innerHTML = '<option value="">-- Selecione --</option>';
            templates.forEach(t => {
                select.innerHTML += `<option value="${t.nome}">${t.nome}</option>`;
            });

            const parts = key.split('-');
            document.getElementById('modal-date-title').innerText = `Dia ${parts[2]}/${parseInt(parts[1])+1}`;

            if (history[key] && history[key] !== 'REST') {
                select.value = history[key];
            } else {
                select.value = "";
            }
            modal.style.display = 'flex';
        }

        function fecharModal(e) {
            if (e.target.id === 'modal-treino') document.getElementById('modal-treino').style.display = 'none';
        }

        function salvarTreinoDoDia(tipo) {
            const select = document.getElementById('modal-select');
            
            if (tipo === 'clear') {
                delete history[selectedDayKey];
            } else if (tipo === 'rest') {
                history[selectedDayKey] = 'REST';
            } else if (tipo === 'done') {
                if(select.value === "") return alert("Escolha o treino!");
                history[selectedDayKey] = select.value;
            }

            localStorage.setItem('gym_history_v2', JSON.stringify(history));
            updateStats();
            renderCalendar(); // Isso atualiza tanto o grid quanto a lista
            document.getElementById('modal-treino').style.display = 'none';
        }

        // SW
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>